// Prisma Schema for TBU Schedule Management System
// Database: SQL Server

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
  // Disable shadow database for SQL Server (not recommended for production)
  // shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

// ============================================
// USERS
// ============================================

model User {
  id           String      @id @default(uuid())
  email        String      @unique @db.NVarChar(255)
  passwordHash String      @map("password_hash") @db.NVarChar(255)
  name         String      @db.NVarChar(255)
  role         String      @default("viewer") @db.NVarChar(20) // Changed from UserRole enum to String
  department   String?     @db.NVarChar(255)
  position     String?     @db.NVarChar(255)
  phone        String?     @db.NVarChar(20)
  avatar       String?     @db.NText
  status       String  @default("active") @db.NVarChar(20) // Changed from UserStatus enum to String
  
  // Relations
  createdSchedules    Schedule[]          @relation("ScheduleCreator")
  approvedSchedules   Schedule[]          @relation("ScheduleApprover")
  scheduleApprovals   ScheduleApproval[]
  createdNews         News[]
  createdAnnouncements Announcement[]
  notifications       Notification[]
  refreshTokens       RefreshToken[]
  meetingRecords      MeetingRecord[]
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")
  
  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

// ============================================
// SCHEDULES
// ============================================



model Schedule {
  id               String          @id @default(uuid())
  date             DateTime        @db.Date
  dayOfWeek        String          @map("day_of_week") @db.NVarChar(20)
  startTime        DateTime          @map("start_time") @db.Time
  endTime          DateTime          @map("end_time") @db.Time
  content          String          @db.NText
  location         String          @db.NVarChar(500)
  leader           String          @db.NVarChar(255)
  participants     String            @default("[]") @db.NText // Changed from Json to String with NText for SQL Server compatibility
  preparingUnit    String          @map("preparing_unit") @db.NVarChar(255)
  cooperatingUnits String?           @map("cooperating_units") @default("[]") @db.NText // Changed from Json to String with NText for SQL Server compatibility
  status           String  @default("draft") @db.NVarChar(20) // Changed from ScheduleStatus enum to String
  eventType        String?          @map("event_type") @db.NVarChar(20) // Loại sự kiện: cuoc_hop, hoi_nghi, tam_ngung
  notes            String?         @db.NText
  
  // Relations
  createdBy    String   @map("created_by")
  creator      User     @relation("ScheduleCreator", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  approvedBy   String?  @map("approved_by")
  approver     User?    @relation("ScheduleApprover", fields: [approvedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  approvals    ScheduleApproval[]
  meetingRecords MeetingRecord[]
  
  // Timestamps
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  approvedAt DateTime? @map("approved_at")
  
  @@index([date])
  @@index([status])
  @@index([leader])
  @@index([createdBy])
  @@index([date, status])
  @@map("schedules")
}

// ============================================
// SCHEDULE APPROVALS (Audit Trail)
// ============================================

model ScheduleApproval {
  id            String         @id @default(uuid())
  scheduleId    String         @map("schedule_id")
  schedule      Schedule       @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  approvedBy    String         @map("approved_by")
  approver      User           @relation(fields: [approvedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  approvedAt    DateTime       @default(now()) @map("approved_at")
  previousStatus String? @map("previous_status") @db.NVarChar(20)
  newStatus     String @map("new_status") @db.NVarChar(20)
  notes         String?        @db.NText
  
  @@index([scheduleId])
  @@index([approvedBy])
  @@map("schedule_approvals")
}

// ============================================
// MEETING RECORDS
// ============================================

model MeetingRecord {
  id                String    @id @default(uuid())
  scheduleId        String    @map("schedule_id")
  schedule          Schedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  
  // Thông tin cuộc họp
  title             String    @db.NVarChar(500)
  meetingDate       DateTime  @map("meeting_date") @db.Date
  startTime         DateTime? @map("start_time") @db.Time
  endTime           DateTime? @map("end_time") @db.Time
  location          String?   @db.NVarChar(500)
  leader            String?   @db.NVarChar(255)
  participants      String    @default("[]") @db.NText // JSON array dạng string
  
  // File ghi âm (JSON array: [{url, filename, duration, uploadedAt, type: 'recorded'|'uploaded'}])
  audioRecordings   String    @default("[]") @db.NText
  
  // Nội dung cuộc họp (rich text)
  content           String?   @db.NText
  
  // Biên bản
  minutes           String?   @db.NText
  
  // Metadata
  createdBy         String    @map("created_by")
  creator           User      @relation(fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  status            String    @default("draft") @db.NVarChar(20) // draft, completed, archived
  notes             String?   @db.NText
  
  // Timestamps
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  completedAt       DateTime? @map("completed_at")
  
  @@index([scheduleId])
  @@index([meetingDate])
  @@index([createdBy])
  @@index([status])
  @@map("meeting_records")
}

// ============================================
// NEWS
// ============================================



model News {
  id          String       @id @default(uuid())
  title       String       @db.NVarChar(500)
  summary     String?      @db.NText
  content     String       @db.NText
  image       String?      @db.NText
  category    String @db.NVarChar(20) // Changed from NewsCategory enum to String
  authorId    String?      @map("author_id")
  author      User?        @relation(fields: [authorId], references: [id])
  authorName  String?      @map("author_name") @db.NVarChar(255) // Denormalized
  views       Int          @default(0)
  publishedAt DateTime     @default(now()) @map("published_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  
  @@index([category])
  @@index([publishedAt(sort: Desc)])
  @@map("news")
}

// ============================================
// ANNOUNCEMENTS
// ============================================



model Announcement {
  id          String               @id @default(uuid())
  title       String               @db.NVarChar(500)
  content     String               @db.NText
  priority    String @default("normal") @db.NVarChar(20) // Changed from AnnouncementPriority enum to String
  publishedAt DateTime             @default(now()) @map("published_at")
  expiresAt   DateTime?            @map("expires_at")
    attachments String @default("[]") @db.NText // Changed from Json to String with NText for SQL Server compatibility
  createdBy   String?              @map("created_by")
  creator     User?                @relation(fields: [createdBy], references: [id])
  createdAt   DateTime             @default(now()) @map("created_at")
  updatedAt   DateTime             @updatedAt @map("updated_at")
  
  @@index([priority])
  @@index([publishedAt(sort: Desc)])
  @@index([expiresAt])
  @@map("announcements")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String   @db.NVarChar(255)
  message   String   @db.NText
  type      String   @db.NVarChar(50) // 'schedule_approved', 'schedule_pending', etc.
  linkedType String?  @map("linked_type") @db.NVarChar(50) // 'schedule', 'news', 'announcement'
  linkedId  String?  @map("linked_id") @db.UniqueIdentifier
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([userId, read])
  @@index([createdAt(sort: Desc)])
  @@map("notifications")
}

// ============================================
// REFRESH TOKENS
// ============================================

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique @db.NVarChar(500)
  expiresAt DateTime  @map("expires_at")
  revoked   Boolean   @default(false)
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

