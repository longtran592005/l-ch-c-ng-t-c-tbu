// Prisma Schema for TBU Schedule Management System
// Database: SQL Server
// EXAMPLE FILE - Copy và thay thế schema.prisma nếu muốn dùng SQL Server

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS
// ============================================

enum UserRole {
  admin
  ban_giam_hieu
  staff
  viewer
}

enum UserStatus {
  active
  inactive
  suspended
}

model User {
  id           String      @id @default(uuid())
  email        String      @unique @db.NVarChar(255)
  passwordHash String      @map("password_hash") @db.NVarChar(255)
  name         String      @db.NVarChar(255)
  role         UserRole    @default(viewer)
  department   String?     @db.NVarChar(255)
  position     String?     @db.NVarChar(255)
  phone        String?     @db.NVarChar(20)
  avatar       String?     @db.NText
  status       UserStatus  @default(active)
  
  // Relations
  createdSchedules    Schedule[]          @relation("ScheduleCreator")
  approvedSchedules   Schedule[]          @relation("ScheduleApprover")
  scheduleApprovals   ScheduleApproval[]
  createdNews         News[]
  createdAnnouncements Announcement[]
  notifications       Notification[]
  refreshTokens       RefreshToken[]
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")
  
  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

// ============================================
// SCHEDULES
// ============================================

enum ScheduleStatus {
  draft
  pending
  approved
  cancelled
}

model Schedule {
  id               String          @id @default(uuid())
  date             DateTime        @db.Date
  dayOfWeek        String          @map("day_of_week") @db.NVarChar(20)
  startTime        String          @map("start_time") @db.Time
  endTime          String          @map("end_time") @db.Time
  content          String          @db.NText
  location         String          @db.NVarChar(500)
  leader           String          @db.NVarChar(255)
  participants     Json            @default("[]") // CHANGED: String[] → Json
  preparingUnit    String          @map("preparing_unit") @db.NVarChar(255)
  cooperatingUnits Json?           @map("cooperating_units") @default("[]") // CHANGED: String[] → Json
  status           ScheduleStatus  @default(draft)
  notes            String?         @db.NText
  
  // Relations
  createdBy    String   @map("created_by")
  creator      User     @relation("ScheduleCreator", fields: [createdBy], references: [id])
  approvedBy   String?  @map("approved_by")
  approver     User?    @relation("ScheduleApprover", fields: [approvedBy], references: [id])
  
  approvals    ScheduleApproval[]
  
  // Timestamps
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  approvedAt DateTime? @map("approved_at")
  
  @@index([date])
  @@index([status])
  @@index([leader])
  @@index([createdBy])
  @@index([date, status])
  @@map("schedules")
}

// ============================================
// SCHEDULE APPROVALS (Audit Trail)
// ============================================

model ScheduleApproval {
  id            String         @id @default(uuid())
  scheduleId    String         @map("schedule_id")
  schedule      Schedule       @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  approvedBy    String         @map("approved_by")
  approver      User           @relation(fields: [approvedBy], references: [id])
  approvedAt    DateTime       @default(now()) @map("approved_at")
  previousStatus ScheduleStatus? @map("previous_status")
  newStatus     ScheduleStatus @map("new_status")
  notes         String?        @db.NText
  
  @@index([scheduleId])
  @@index([approvedBy])
  @@map("schedule_approvals")
}

// ============================================
// NEWS
// ============================================

enum NewsCategory {
  news
  announcement
  event
}

model News {
  id          String       @id @default(uuid())
  title       String       @db.NVarChar(500)
  summary     String?      @db.NText
  content     String       @db.NText
  image       String?      @db.NText
  category    NewsCategory
  authorId    String?      @map("author_id")
  author      User?        @relation(fields: [authorId], references: [id])
  authorName  String?      @map("author_name") @db.NVarChar(255) // Denormalized
  views       Int          @default(0)
  publishedAt DateTime     @default(now()) @map("published_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  
  @@index([category])
  @@index([publishedAt(sort: Desc)])
  @@map("news")
}

// ============================================
// ANNOUNCEMENTS
// ============================================

enum AnnouncementPriority {
  normal
  important
  urgent
}

model Announcement {
  id          String               @id @default(uuid())
  title       String               @db.NVarChar(500)
  content     String               @db.NText
  priority    AnnouncementPriority @default(normal)
  publishedAt DateTime             @default(now()) @map("published_at")
  expiresAt   DateTime?            @map("expires_at")
  attachments Json                 @default("[]") // CHANGED: String[] → Json
  createdBy   String?              @map("created_by")
  creator     User?                @relation(fields: [createdBy], references: [id])
  createdAt   DateTime             @default(now()) @map("created_at")
  updatedAt   DateTime             @updatedAt @map("updated_at")
  
  @@index([priority])
  @@index([publishedAt(sort: Desc)])
  @@index([expiresAt])
  @@map("announcements")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String   @db.NVarChar(255)
  message   String   @db.NText
  type      String   @db.NVarChar(50) // 'schedule_approved', 'schedule_pending', etc.
  linkedType String?  @map("linked_type") @db.NVarChar(50) // 'schedule', 'news', 'announcement'
  linkedId  String?  @map("linked_id") @db.UniqueIdentifier
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([userId, read])
  @@index([createdAt(sort: Desc)])
  @@map("notifications")
}

// ============================================
// REFRESH TOKENS
// ============================================

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique @db.NVarChar(500)
  expiresAt DateTime  @map("expires_at")
  revoked   Boolean   @default(false)
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

